---
output: github_document
---

```{r setup, echo = FALSE}
library(data.table)
library(ggplot2)
```

# Description of the model

This is a variation of a SEIRD model, which includes hospitalizations. The specific features follow:

- Two types of network connections: families and bi-partite through entities.
- Individuals are clustered in groups of five.
- Each entity houses 100 individuals.
- Transmission can happen between family members or between entity members.
- At each step, the model draws 5 entity members per susceptible individual. This represents the chance of direct contact.
- Only infected non-hospitalized individuals can transmit the disease.

The file [`params.txt`](params.txt) contains the model parameters. The current values are:

```{r listing-params, echo = FALSE}
params <- readLines("params.txt", warn = FALSE)
params <- params[grepl("^[^*]", params)]
params <- data.frame(
    Parameter = gsub("\\s*[:].+", "", params),
    Value     = as.numeric(gsub("^[^:]+[:]", "", params))
)
knitr::kable(params, row.names = FALSE)
```

The full program can be found in the file [main.cpp](main.cpp).

# Running the model

```{bash}
./main.o
```

# Computing reproductive number

```{r repnum}
rt <- list.files("saves", pattern = "reproductive", full.names = TRUE)
rt <- lapply(seq_along(rt), \(i) {cbind(id = i, fread(rt[i]))}) |>
    rbindlist()

# Computing for each individual
rt <- rt[, .(rt = mean(rt)), by = c("id", "source_exposure_date", "thread")]
setorder(rt, source_exposure_date)

ggplot(rt, aes(x = source_exposure_date, y = rt)) +
    geom_jitter(aes(colour = as.factor(thread == 0)), alpha = .1) +
    geom_smooth() +
    lims(y = c(0, 5))

setorder(rt, id, source_exposure_date, rt)
fwrite(rt, "reproductive_numbers.csv")
```

# Epi curves

```{r transitions}
epicurves <- list.files("saves", pattern = "hist", full.names = TRUE)
epicurves <- lapply(seq_along(epicurves), \(i) {
    cbind(id = i, fread(epicurves[i]))
}) |> rbindlist()

fwrite(epicurves, "epicurves.csv")

epicurves[status %in% c("Exposed", "Infected", "Hospitalized")] |>
    ggplot(aes(x = date, y = counts, shape = as.factor(thread == 0))) +
    geom_smooth(aes(colour = status)) +
    geom_jitter(aes(colour = status), alpha = .1)
```

```{r totals}
epicurves[!status %in% c("Exposed", "Infected", "Hospitalized")] |>
    ggplot(aes(x = date, y = counts)) +
    geom_smooth(aes(colour = status)) +
    geom_jitter(aes(colour = status), alpha = .1)
```

Status at the end of the simulation

```{r status-at-the-end}
epicurves_end <- epicurves[date == max(date)]
epicurves_end[, .(
    Avg     = mean(counts),
    `50%`   = quantile(counts, probs = .5),
    `2.5%`  = quantile(counts, probs = .025),
    `97.5%` = quantile(counts, probs = .975)
    ), by = "status"] |> knitr::kable()
```

